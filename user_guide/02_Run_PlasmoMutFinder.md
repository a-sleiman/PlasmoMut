# PlasmoMutFinder User Guide

This guide explains how to use the PlasmoMutFinder R script to identify candidate variants associated with ACT treatment failure in Plasmodium falciparum. It details installation, input/output, usage, and interpretation of results.

## 1. Overview

PlasmoMutFinder R script is the next step after you have successfully generated the combined and filtered VCF file. It identifies variants exclusive to ACT treatment failure cases in Plasmodium falciparum, filters variants by group, keeps only missense mutations, generates summary statistics, and plots mutation presence using an UpSet plot.

---

## 2. Requirements

* **R version**: R ≥ 4.2

* **Libraries**:

```r
# Install if missing
install.packages("openxlsx")
install.packages("UpSetR")
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install("VariantAnnotation")

# Load libraries
library(VariantAnnotation)
library(openxlsx)
library(UpSetR)
```

---

## 3. Input Files

The pipeline requires the following structure inside `PlasmoMut/`:

- **Sample classification file (Excel)** – Columns: `Sample` (sample names) and `Group` (Fail/Success). Fail indicates that ACT treatment failed for that sample, Success indicates treatment was effective.

   * Example: `input/metadata/labels.xlsx`

- **Merged multi-sample VCF file**

   * Example: `output/vcf/SNP_filtered.vcf`

**Note:** Paths should be adjusted based on your project directory or use relative paths from the script.

---

## 4. Output Files

All results are written to `PlasmoMut/output/R/`.

- **Filtered VCFs**
   - `variants_Fail_uniques.vcf` – variants found only in Fail samples
   - `missense_variant.vcf` – only missense variants

- **Summary Report** → Saved as a log text file (`summary_report.txt`) including:
     - Total variants in original VCF
     - Variants after Fail-only filtering
     - Variants after missense filtering
     - Total execution time

- **Mutation Plot** → UpSet plot showing presence/absence of missense variants: `upset_plot.jpeg`

---

## 5. Usage

1. Set your working directory to the project root (where your input and output folders are located):

```r
setwd("C:/Stages/StageESCAPE/PlasmoMut")  # change to your path
```

2. Modify paths in the script for portability (example):

```r
log_path <- file.path(getwd(), "output", "R", "summary_report.txt")
labels_path <- file.path(getwd(), "input", "metadata", "labels.xlsx")
vcf_path <- file.path(getwd(), "output", "vcf", "SNP_filtered.vcf")
```

3. Run the script:

```r
source("PlasmoMutFinder.R")
```

---

## 6. Script Workflow

1. **Load input files** – VCF and sample metadata
2. **Match sample classification** – Fail vs Success
3. **Encode genotypes** – extract allele patterns per group
4. **Filter variants** – keep only variants unique to Fail group
5. **Missense filtering** – keep only missense variants
6. **Save filtered VCFs** – for downstream analyses
7. **Generate summary report** – including statistics and execution time
8. **Plot variants** – UpSet plot showing mutation distribution

---

## 7. Notes / Tips

* Ensure sample names in VCF match exactly with the labels file.
* Script stops if unmatched samples are found.
* Adjust output file paths to avoid overwriting files if running multiple times.
* For large VCFs, processing can take several minutes.

---

## 8. Next Step

Once you have plots and results, CONGRATULATIONS, you now have candidate genes responsible or not for ACT treatment failure, you can now do further analysis on the candidates.
If you want you can check the quality of the bam files generated by the .sh script, not mandatory, but it will give you a quick overview with easy interactive plots to check the reads etc......
Proceed next to `PlasmoMut/Scripts/R/SeqQualPlot15.R`.

---

## 9. Support

For issues or questions, contact me or open an issue on the GitHub repository.